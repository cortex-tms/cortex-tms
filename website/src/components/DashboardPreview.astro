---
/**
 * DashboardPreview ‚Äî data-driven terminal UI preview.
 * Content lives in src/content/homepage/dashboard-preview.md
 */
import { getCollection } from 'astro:content'
import type { DashboardPreviewEntry } from '../types/homepage'
import './DashboardPreview.css'

const entries = await getCollection('homepage')
const entry = entries.find(
  (e): e is DashboardPreviewEntry => e.data.type === 'dashboard-preview'
)
if (!entry) throw new Error('Missing dashboard-preview content entry')

const { project, time, overview, files, health } = entry.data

// Block bar helpers ‚Äî 40 chars for progress bars, 20 for distribution bars
function bar(pct: number, total = 40) {
  const n = Math.round((pct / 100) * total)
  return { filled: '‚ñà'.repeat(n), empty: '‚ñà'.repeat(total - n) }
}
function distBar(count: number, total = 20) {
  return { filled: '‚ñà'.repeat(Math.min(count, total)), empty: '‚ñà'.repeat(Math.max(0, total - count)) }
}

const freshBar  = bar(overview.freshness.percentage)
const sprintBar = bar(overview.sprint.percentage)

const tierMeta: Record<string, { icon: string; color: string; label: string }> = {
  HOT:  { icon: 'üî•', color: 'yellow', label: 'üî• HOT' },
  WARM: { icon: '',   color: 'blue',   label: '~ WARM' },
  COLD: { icon: '‚ùÑÔ∏è', color: 'cyan',   label: '‚ùÑÔ∏è COLD' },
}
---

<div class='dashboard-preview'>
  <div class='dp-header'>
    <div class='dp-dots'>
      <span class='dp-dot dp-dot-red'></span>
      <span class='dp-dot dp-dot-yellow'></span>
      <span class='dp-dot dp-dot-green'></span>
    </div>
  </div>

  <div class='dp-terminal-window'>
    <div class='dp-brand'>
      <span class='dp-brand-name'>‚óÜ CORTEX TMS DASHBOARD</span>
    </div>

    <div class='dp-meta-row'>
      <div class='dp-project'>Project: <span>{project}</span></div>
      <div class='dp-time'>{time}</div>
    </div>

    <div class='dp-tabs' role='tablist'>
      <button class='dp-tab dp-tab-active' data-view='overview' role='tab' aria-selected='true'>
        <span class='dp-tab-bracket'>[</span>1. Overview<span class='dp-tab-bracket'>]</span>
      </button>
      <button class='dp-tab' data-view='files' role='tab' aria-selected='false'>
        <span class='dp-tab-bracket' style='opacity: 0.4;'>[</span>2. Files<span class='dp-tab-bracket' style='opacity: 0.4;'>]</span>
      </button>
      <button class='dp-tab' data-view='health' role='tab' aria-selected='false'>
        <span class='dp-tab-bracket' style='opacity: 0.4;'>[</span>3. Health<span class='dp-tab-bracket' style='opacity: 0.4;'>]</span>
      </button>
    </div>

    <div class='dp-views'>

      {/* ‚îÄ‚îÄ Overview ‚îÄ‚îÄ */}
      <div class='dp-view dp-view-active' id='dp-view-overview'>
        <div class='dp-grid-2'>
          <fieldset class='dp-card'>
            <legend class='dp-card-title green'>‚úÖ GOVERNANCE HEALTH</legend>
            <div class='dp-score'>{overview.health.score}<span class='dp-score-denom'>/100</span></div>
            <div class='dp-score-label'>overall quality score</div>
            <div class='dp-card-rows'>
              {overview.health.rows.map((row) => (
                <div class='dp-row'>
                  <span class='dp-row-key'>{row.key}:</span>
                  <span class={`dp-row-val ${row.color}`}>{row.value}</span>
                </div>
              ))}
            </div>
          </fieldset>

          <fieldset class='dp-card'>
            <legend class='dp-card-title cyan'>üìÖ DOCUMENTATION FRESHNESS</legend>
            <div class='dp-block-bar'>
              <span class='dp-block-filled'>{freshBar.filled}</span><span class='dp-block-empty'>{freshBar.empty}</span>
            </div>
            <div class='dp-freshness-pct'>{overview.freshness.percentage}%</div>
            <div class='dp-card-rows'>
              {overview.freshness.rows.map((row) => (
                <div class='dp-row'>
                  <span class='dp-row-key'>{row.key}:</span>
                  <span class={`dp-row-val ${row.color}`}>{row.value}</span>
                </div>
              ))}
            </div>
          </fieldset>
        </div>

        <fieldset class='dp-card dp-card-full'>
          <legend class='dp-card-title cyan'>üéØ SPRINT PROGRESS</legend>
          <div class='dp-row' style='margin-bottom: 0.75rem;'>
            <span class='dp-row-key'>Current:</span>
            <span class='white'>{overview.sprint.name}</span>
          </div>
          <div class='dp-progress-wrapper'>
            <div class='dp-block-bar'>
              <span class='dp-block-filled'>{sprintBar.filled}</span><span class='dp-block-empty'>{sprintBar.empty}</span>
            </div>
            <span class='dp-progress-pct white'>{overview.sprint.percentage}%</span>
          </div>
          <div class='dp-sprint-stats'>
            <span class='green'>‚úÖ Done: {overview.sprint.done}</span>
            <span class='dp-divider'>‚îÇ</span>
            <span class='cyan'>üîÑ In Progress: {overview.sprint.inProgress}</span>
            <span class='dp-divider'>‚îÇ</span>
            <span class='dp-dim'>üìã Todo: {overview.sprint.todo}</span>
          </div>
        </fieldset>
      </div>

      {/* ‚îÄ‚îÄ Files ‚îÄ‚îÄ */}
      <div class='dp-view' id='dp-view-files'>
        <fieldset class='dp-card dp-card-full'>
          <legend class='dp-card-title yellow'>üî• ACTIVE FILES ({files.activeFiles.count})</legend>
          <div class='dp-file-list'>
            {files.activeFiles.list.map((f) => (
              <div class='dp-file'><span class='dp-bullet'>‚Ä¢</span>{f}</div>
            ))}
          </div>
          <div class='dp-card-footer'>{files.activeFiles.footer}</div>
        </fieldset>

        <fieldset class='dp-card dp-card-full'>
          <legend class='dp-card-title'>üìÅ FILE DISTRIBUTION</legend>
          {files.distribution.map((tier) => {
            const meta = tierMeta[tier.tier]
            const b = distBar(tier.count)
            return (
              <div class='dp-dist-row'>
                <span class={`dp-dist-label ${meta.color}`}>{meta.label}</span>
                <span class='dp-dist-count'>{tier.count}</span>
                <span class='dp-dist-pct dp-dim'>({tier.percentage}%)</span>
                <div class='dp-dist-bar-text'>
                  <span class={meta.color}>{b.filled}</span><span class='dp-bar-empty'>{b.empty}</span>
                </div>
              </div>
            )
          })}
        </fieldset>

        <fieldset class='dp-card dp-card-full dp-card-yellow'>
          <legend class='dp-card-title yellow'>üìè FILE SIZE HEALTH</legend>
          {files.sizeHealth.map((f) => {
            const pct = Math.round((f.lines / f.maxLines) * 100)
            const color = pct >= 80 ? 'yellow' : 'green'
            return (
              <div class='dp-size-row'>
                <span class='dp-size-emoji'>{f.emoji}</span>
                <span class={`dp-size-file ${color}`}>{f.name}</span>
                <span class='dp-dim'>{f.lines}/{f.maxLines} lines ({pct}%)</span>
              </div>
            )
          })}
        </fieldset>
      </div>

      {/* ‚îÄ‚îÄ Health ‚îÄ‚îÄ */}
      <div class='dp-view' id='dp-view-health'>
        <fieldset class='dp-card dp-card-full dp-card-green'>
          <legend class='dp-card-title green'>‚ñ† VALIDATION STATUS</legend>
          <div class='dp-health-status green'>‚úÖ {health.validation.status}</div>
          <div class='dp-dim dp-health-meta'>Last checked: {health.validation.lastChecked}</div>
        </fieldset>

        <fieldset class='dp-card dp-card-full dp-card-green'>
          <legend class='dp-card-title green'>‚ñ† GUARDIAN CODE REVIEW</legend>
          <div class='dp-health-status green'>‚úÖ {health.guardian.status}</div>
          <div class='dp-dim dp-health-meta'>Last review: {health.guardian.lastReview}</div>
          <div class='dp-health-meta dp-dim'>
            Run: <span class='cyan'>{health.guardian.command}</span>
          </div>
        </fieldset>
      </div>

    </div>{/* /.dp-views */}

    <div class='dp-footer'>
      <div>Tab: Switch view &nbsp;‚Ä¢&nbsp; 1/2/3: Jump to view &nbsp;‚Ä¢&nbsp; q: Quit</div>
      <div>Use <code>--live</code> for auto-refresh (5s interval)</div>
    </div>
  </div>
</div>

<script>
  import './DashboardPreview'
</script>
