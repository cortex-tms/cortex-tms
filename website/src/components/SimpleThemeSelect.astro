---
/**
 * Simple Theme Select - Custom theme switcher for SimpleLayout
 *
 * Uses icon buttons instead of dropdown for better UX
 */
import { Sun, Moon, Monitor } from '@lucide/astro';
---

<div class='theme-selector glass-shell'>
  <button
    class='theme-button'
    data-theme='light'
    aria-label='Light theme'
    title='Light theme'
  >
    <Sun size={20} />
  </button>

  <button
    class='theme-button'
    data-theme='dark'
    aria-label='Dark theme'
    title='Dark theme'
  >
    <Moon size={20} />
  </button>

  <button
    class='theme-button'
    data-theme='auto'
    aria-label='Auto theme'
    title='Auto theme (system)'
  >
    <Monitor size={20} />
  </button>
</div>

<style>
  .theme-selector {
    display: flex;
    align-items: center;
    gap: 0.125rem;
    --theme-button-surface: rgba(255, 255, 255, 0.06);
    --theme-button-surface-active: rgba(249, 115, 22, 0.16);
    --theme-button-icon: var(--sl-color-gray-3);
    background: var(--glass-surface, rgba(255, 255, 255, 0.04));
    border: 1px solid var(--glass-border, rgba(255, 255, 255, 0.08));
    backdrop-filter: blur(var(--glass-blur, 12px));
    -webkit-backdrop-filter: blur(var(--glass-blur, 12px));
    border-radius: 12px;
    padding: 0.25rem 0.35rem;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.24);
    position: relative;
    isolation: isolate;
  }

  :root[data-theme='light'] .theme-selector {
    --theme-button-surface: rgba(17, 17, 17, 0.06);
    --theme-button-surface-active: rgba(249, 115, 22, 0.12);
    --theme-button-icon: var(--sl-color-gray-3);
  }

  .theme-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.25rem;
    height: 2.25rem;
    line-height: 1;
    padding: 0;
    border: none;
    background: transparent;
    color: var(--theme-button-icon);
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.2s ease;
    position: relative;
  }

  .theme-button::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--theme-button-surface);
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .theme-button:hover::before {
    opacity: 1;
  }

  .theme-button:hover {
    color: var(--sl-color-text);
  }

  .theme-button.active {
    color: var(--sl-color-accent-high);
  }

  .theme-button.active::before {
    background: var(--theme-button-surface-active);
    opacity: 1;
  }

  .theme-button svg {
    width: 1.125rem;
    height: 1.125rem;
    position: relative;
    z-index: 1;
  }

  .theme-button:focus-visible {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  @media (max-width: 640px) {
    .theme-button {
      width: 2rem;
      height: 2rem;
    }

    .theme-selector {
      gap: 0.25rem;
    }
  }
</style>

<script>
  type Theme = 'auto' | 'dark' | 'light'

  const storageKey = 'starlight-theme'

  const parseTheme = (theme: unknown): Theme =>
    theme === 'auto' || theme === 'dark' || theme === 'light' ? theme : 'auto'

  const loadTheme = (): Theme =>
    parseTheme(
      typeof localStorage !== 'undefined' && localStorage.getItem(storageKey),
    )

  function storeTheme(theme: Theme): void {
    if (typeof localStorage !== 'undefined') {
      localStorage.setItem(
        storageKey,
        theme === 'light' || theme === 'dark' ? theme : '',
      )
    }
  }

  const getPreferredColorScheme = (): Theme =>
    matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'

  function updateButtons(theme: Theme) {
    document.querySelectorAll('.theme-button').forEach((button) => {
      const buttonTheme = button.getAttribute('data-theme')
      if (buttonTheme === theme) {
        button.classList.add('active')
      } else {
        button.classList.remove('active')
      }
    })
  }

  function onThemeChange(theme: Theme): void {
    updateButtons(theme)
    document.documentElement.dataset.theme =
      theme === 'auto' ? getPreferredColorScheme() : theme
    storeTheme(theme)
  }

  // Initialize on load
  onThemeChange(loadTheme())

  // React to button clicks
  document.querySelectorAll('.theme-button').forEach((button) => {
    button.addEventListener('click', () => {
      const theme = parseTheme(button.getAttribute('data-theme'))
      onThemeChange(theme)
    })
  })

  // React to changes in system color scheme
  matchMedia('(prefers-color-scheme: light)').addEventListener('change', () => {
    if (loadTheme() === 'auto') onThemeChange('auto')
  })
</script>
