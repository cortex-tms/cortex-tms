---
/**
 * TokenCounter - Animated token reduction display
 * Shows before/after token counts with animated transition
 */
import GlassPanel from './GlassPanel.astro';
import { TrendingDown } from '@lucide/astro';
import '../styles/token-counter.css';
---

<GlassPanel variant="bordered" class="token-counter">
  <div class="panel-content" style="text-align: center;">
    <div class="counter-header">
      <TrendingDown size={32} stroke-width="1.5" />
      <h3>Context Reduction</h3>
    </div>

    <div class="counter-metrics">
      <div class="metric-item">
        <div class="metric-label">Before</div>
        <div class="metric-value before" data-target="66834">0</div>
        <div class="metric-unit">tokens</div>
      </div>

      <div class="arrow">→</div>

      <div class="metric-item">
        <div class="metric-label">After</div>
        <div class="metric-value after" data-target="3647">0</div>
        <div class="metric-unit">tokens</div>
      </div>
    </div>

    <div class="counter-result">
      <div class="reduction-badge">
        <span class="reduction-value">94.5%</span>
        <span class="reduction-label">reduction</span>
      </div>
      <div class="cost-savings">
        <span class="cost-before">$0.20</span>
        <span class="cost-arrow">→</span>
        <span class="cost-after">$0.01</span>
        <span class="cost-label">per session</span>
      </div>
    </div>
  </div>
</GlassPanel>

<script>
  // Animate counter on scroll into view
  function animateCounter(element: HTMLElement) {
    const target = parseInt(element.dataset.target || '0');
    const duration = 2000; // 2 seconds
    const steps = 60;
    const increment = target / steps;
    let current = 0;
    let step = 0;

    const timer = setInterval(() => {
      step++;
      current += increment;

      if (step >= steps) {
        current = target;
        clearInterval(timer);
      }

      element.textContent = Math.floor(current).toLocaleString();
    }, duration / steps);
  }

  // Intersection Observer to trigger animation when visible
  document.addEventListener('DOMContentLoaded', () => {
    const counters = document.querySelectorAll('.metric-value[data-target]');

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const element = entry.target as HTMLElement;
          if (element.textContent === '0') {
            animateCounter(element);
          }
          observer.unobserve(element);
        }
      });
    }, { threshold: 0.5 });

    counters.forEach((counter) => observer.observe(counter));
  });
</script>
